version: '3'

tasks:
  # Assemble the LinuxBoot initramfs
  loader-cpio:
    dir: build
    cmds:
      - echo "Assembling LinuxBoot initramfs..."
      - mkdir -p kmod && touch kmod/bootlock.ko # Needed because not all targets have modules
      - sh -c "cd boot/loader/; echo loader | cpio --format newc --create --file ../loader.cpio"
      - sh -c "cd boot/keys/; echo u-bmc.pub | cpio --format newc --create --append --file ../loader.cpio"
      - sh -c "cd kmod/; echo *.ko | cpio --format newc --create --append --file ../boot/loader.cpio"
      - sh -c "cd boot/; echo kexec | cpio --format newc --create --append --file loader.cpio"
      - echo "Done!"
    status:
      - test -f loader.cpio
